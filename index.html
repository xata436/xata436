<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мониторинг сервисов</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        .status-card {
            transition: transform 0.2s;
            border: none;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .status-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        .status-icon {
            font-size: 1.5rem;
            margin-right: 10px;
        }
        .badge {
            font-size: 0.85em;
        }
        .info-value {
            font-family: 'Courier New', monospace;
            background-color: rgba(255, 255, 255, 0.05);
            padding: 5px 10px;
            border-radius: 4px;
            border: 1px solid #444;
        }
        .last-updated {
            font-size: 0.85rem;
            opacity: 0.7;
        }
    </style>
</head>
<body class="bg-dark text-light">
    <div class="container py-5">
        <header class="text-center mb-5">
            <h1 class="display-5 fw-bold"><i class="bi bi-speedometer2"></i> Мониторинг сервисов</h1>
            <p class="lead">Отслеживание текущего подключения и доступности ключевых систем</p>
        </header>

        <!-- Секция информации о пользователе -->
        <section class="mb-5">
            <h2 class="h4 mb-3 border-bottom pb-2"><i class="bi bi-pc-display-horizontal"></i> Ваше подключение</h2>
            <div class="row g-3">
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark border rounded">
                        <span class="fw-medium">IP-адрес:</span>
                        <span id="ipAddress" class="info-value">Определяется...</span>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="d-flex justify-content-between align-items-center p-3 bg-dark border rounded">
                        <span class="fw-medium">Приблизительное местоположение:</span>
                        <span id="userLocation" class="info-value">Определяется...</span>
                    </div>
                </div>
            </div>
            <div class="mt-2 text-end">
                <button id="btnRefreshIp" class="btn btn-sm btn-outline-secondary">
                    <i class="bi bi-arrow-clockwise"></i> Обновить
                </button>
            </div>
        </section>

        <!-- Секция статуса сервисов -->
        <section class="mb-5">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h2 class="h4 mb-0"><i class="bi bi-heart-pulse"></i> Доступность сервисов</h2>
                <div>
                    <button id="btnCheckAll" class="btn btn-outline-primary btn-sm me-2">
                        <i class="bi bi-play-circle"></i> Проверить все
                    </button>
                    <span class="last-updated">Последняя проверка: <span id="lastCheckTime">—</span></span>
                </div>
            </div>

            <div class="row g-4" id="servicesContainer">
                <!-- Карточки сервисов будут созданы здесь JavaScript -->
            </div>
        </section>

        <footer class="text-center mt-5 pt-4 border-top text-muted small">
            <p>Система мониторинга xata436</p>
        </footer>
    </div>

    <!-- Bootstrap JS с Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // Конфигурация проверяемых сервисов
        const services = [
            {
                id: 'internet',
                name: 'Интернет (ДАПЛ)',
                url: 'http://xata436.crazedns.ru',
                description: 'Наличие интернет-соединения ДАТАПЛАНЕТ в серверной',
                checkType: 'http'
            },
            {
                id: 'proxy',
                name: 'Прокси (М9)',
                url: 'http://xata436.ru:7721/',
                description: 'Прокси-сервер, который располагается в М9',
                checkType: 'http'
            },
            {
                id: 'win-server',
                name: 'Windows-сервер',
                url: 'http://xata436.ru:63389/',
                description: 'Доступность Windows-сервера',
                checkType: 'tcp',
                alwaysAvailable: true
            },
            {
                id: 'ubuntu-server',
                name: 'Ubuntu-сервер',
                url: 'http://xata436.ru:53389/',
                description: 'Доступность Linux-сервера,
                checkType: 'tcp'
            },
            {
                id: 'gitlab',
                name: 'GitLab',
                url: 'https://git.xata436.ru',
                description: 'Доступность сайта GitLab xata436',
                checkType: 'http'
            },
            {
                id: 'website',
                name: 'Сайт',
                url: 'https://xata436.ru',
                description: 'Доступность основного веб-сайта',
                checkType: 'http'
            }
        ];

        // Элементы DOM
        const ipAddressEl = document.getElementById('ipAddress');
        const userLocationEl = document.getElementById('userLocation');
        const btnRefreshIp = document.getElementById('btnRefreshIp');
        const btnCheckAll = document.getElementById('btnCheckAll');
        const lastCheckTimeEl = document.getElementById('lastCheckTime');
        const servicesContainer = document.getElementById('servicesContainer');

        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            loadIpAndLocation();
            renderServiceCards();
            checkAllServices();
        });

        // ==================== ФУНКЦИИ ДЛЯ IP И ГЕОЛОКАЦИИ ====================
        async function loadIpAndLocation() {
            try {
                // Получение IP через сторонний API
                const ipResponse = await fetch('https://api.ipify.org?format=json');
                const ipData = await ipResponse.json();
                const userIp = ipData.ip;
                ipAddressEl.textContent = userIp;
                ipAddressEl.className = 'info-value text-success';

                // Получение геолокации по IP
                try {
                    // Используем ipinfo.io, который возвращает и IP, и геоданные
                    const geoResponse = await fetch(`https://ipinfo.io/${userIp}/json?token=`);
                    const geoData = await geoResponse.json();
                    let locationStr = '';
                    if (geoData.city) locationStr += geoData.city;
                    if (geoData.region) locationStr += `, ${geoData.region}`;
                    if (geoData.country) locationStr += `, ${geoData.country}`;
                    if (locationStr) {
                        userLocationEl.textContent = locationStr;
                    } else {
                        userLocationEl.textContent = 'Город не определён';
                    }
                } catch (geoError) {
                    userLocationEl.textContent = 'Локация не определена';
                }
            } catch (error) {
                ipAddressEl.textContent = 'Ошибка загрузки';
                ipAddressEl.className = 'info-value text-danger';
                userLocationEl.textContent = '—';
            }
        }

        // ==================== ФУНКЦИИ ДЛЯ ПРОВЕРКИ СЕРВИСОВ ====================
        // Функция для проверки HTTP/HTTPS сервиса
        async function checkHttpService(url, serviceId) {
            try {
                // Специальная проверка для прокси (М9)
                if (serviceId === 'proxy') {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);
                        const response = await fetch(url, {
                            signal: controller.signal,
                            credentials: 'omit'
                        });
                        clearTimeout(timeoutId);
                        
                        // Проверяем наличие окна авторизации или текста "Вход запрещен"
                        const text = await response.text();
                        if (text.includes('Вход запрещен') || 
                            text.toLowerCase().includes('authorization') ||
                            text.toLowerCase().includes('authenticate') ||
                            response.status === 401) {
                            return 'available';
                        }
                        return 'unavailable';
                    } catch (e) {
                        return 'unavailable';
                    }
                }
                
                // Для остальных HTTP-сервисов
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000);
                const response = await fetch(url, {
                    method: 'HEAD',
                    mode: 'no-cors',
                    signal: controller.signal
                });
                clearTimeout(timeoutId);
                return 'available'; // Если запрос выполнен
            } catch (error) {
                // Для Keenetic проверяем через текст
                if (url.includes('crazedns.ru')) {
                    try {
                        const controller = new AbortController();
                        const timeoutId = setTimeout(() => controller.abort(), 8000);
                        const textResponse = await fetch(url, {
                            signal: controller.signal
                        });
                        clearTimeout(timeoutId);
                        const text = await textResponse.text();
                        if (text.includes('Keenetic') || text.includes('router') || text.includes('логин')) {
                            return 'available';
                        }
                        return 'unavailable';
                    } catch (e) {
                        return 'unavailable';
                    }
                }
                return 'unavailable';
            }
        }

        // Функция для проверки TCP порта (RDP серверов)
        async function checkTcpService(url) {
            try {
                const urlObj = new URL(url);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 5000);
                // Пытаемся установить TCP соединение через WebSocket или fetch с указанным портом
                const response = await fetch(`https://cors-anywhere.herokuapp.com/${url}`, {
                    method: 'HEAD',
                    mode: 'cors',
                    signal: controller.signal,
                    headers: { 'X-Requested-With': 'XMLHttpRequest' }
                });
                clearTimeout(timeoutId);
                return 'available';
            } catch (error) {
                // Альтернативная проверка - попытка загрузить изображение с порта
                return new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => resolve('available');
                    img.onerror = () => resolve('unavailable');
                    img.src = `${url}/favicon.ico?t=${Date.now()}`;
                    setTimeout(() => resolve('unavailable'), 4000);
                });
            }
        }

        // Функция для получения текущего статуса сервиса
        function getServiceStatus(serviceId) {
            const badgeEl = document.getElementById(`badge-${serviceId}`);
            if (!badgeEl) return 'unknown';
            
            if (badgeEl.textContent === 'Доступен') return 'available';
            if (badgeEl.textContent === 'Недоступен') return 'unavailable';
            if (badgeEl.textContent === 'Проверка...') return 'checking';
            return 'unknown';
        }

        // Основная функция проверки сервиса
        async function checkService(service) {
            // Если это Windows-сервер, всегда возвращаем "available"
            if (service.id === 'win-server' && service.alwaysAvailable) {
                updateServiceCard(service.id, 'available');
                return 'available';
            }
            
            let status = 'checking';
            updateServiceCard(service.id, status);
            
            try {
                if (service.checkType === 'tcp') {
                    status = await checkTcpService(service.url);
                } else {
                    status = await checkHttpService(service.url, service.id);
                }
            } catch (error) {
                status = 'error';
            }
            
            // Проверка условия: если GitLab И Сайт не работают, то Ubuntu-сервер не работает
            if (service.id === 'ubuntu-server') {
                const gitlabStatus = getServiceStatus('gitlab');
                const websiteStatus = getServiceStatus('website');
                
                if (gitlabStatus === 'unavailable' && websiteStatus === 'unavailable') {
                    status = 'unavailable';
                }
            }
            
            updateServiceCard(service.id, status);
            return status;
        }

        // Функция проверки всех сервисов
        async function checkAllServices() {
            btnCheckAll.disabled = true;
            btnCheckAll.innerHTML = '<i class="bi bi-hourglass-split"></i> Проверяем...';
            
            // Проверяем сервисы в определенном порядке для правильной логики зависимостей
            const checkOrder = ['internet', 'proxy', 'gitlab', 'website', 'ubuntu-server', 'win-server'];
            
            for (const serviceId of checkOrder) {
                const service = services.find(s => s.id === serviceId);
                if (service) {
                    await checkService(service);
                }
            }
            
            updateLastCheckTime();
            btnCheckAll.disabled = false;
            btnCheckAll.innerHTML = '<i class="bi bi-play-circle"></i> Проверить все';
        }

        // ==================== ФУНКЦИИ ОТОБРАЖЕНИЯ ====================
        // Создание карточек сервисов
        function renderServiceCards() {
            servicesContainer.innerHTML = '';
            services.forEach(service => {
                const cardCol = document.createElement('div');
                cardCol.className = 'col-md-6 col-lg-4';
                cardCol.innerHTML = `
                    <div class="card status-card h-100 bg-dark border-secondary">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-3">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-hdd-network status-icon" id="icon-${service.id}"></i>
                                    ${service.name}
                                </h5>
                                <span class="badge bg-secondary" id="badge-${service.id}">—</span>
                            </div>
                            <p class="card-text small text-muted">${service.description}</p>
                            <div class="mt-3">
                                <div class="small text-truncate mb-1">
                                    <i class="bi bi-link-45deg"></i> 
                                    <a href="${service.url}" target="_blank" class="text-decoration-none">${service.url}</a>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div id="progress-${service.id}" class="progress-bar" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-dark border-top-0 pt-0">
                            <button class="btn btn-sm btn-outline-secondary w-100 check-service-btn" data-service-id="${service.id}">
                                <i class="bi bi-arrow-repeat"></i> Проверить
                            </button>
                        </div>
                    </div>
                `;
                servicesContainer.appendChild(cardCol);
            });
            // Назначение обработчиков для кнопок проверки
            document.querySelectorAll('.check-service-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const serviceId = this.getAttribute('data-service-id');
                    const service = services.find(s => s.id === serviceId);
                    if (service) checkService(service);
                });
            });
        }

        // Обновление отображения карточки сервиса
        function updateServiceCard(serviceId, status) {
            const iconEl = document.getElementById(`icon-${serviceId}`);
            const badgeEl = document.getElementById(`badge-${serviceId}`);
            const progressEl = document.getElementById(`progress-${serviceId}`);
            if (!iconEl || !badgeEl || !progressEl) return;
            let iconClass, badgeClass, badgeText, progressClass;
            switch (status) {
                case 'available':
                    iconClass = 'bi-check-circle-fill text-success';
                    badgeClass = 'bg-success';
                    badgeText = 'Доступен';
                    progressClass = 'bg-success';
                    break;
                case 'unavailable':
                    iconClass = 'bi-x-circle-fill text-danger';
                    badgeClass = 'bg-danger';
                    badgeText = 'Недоступен';
                    progressClass = 'bg-danger';
                    break;
                case 'checking':
                    iconClass = 'bi-arrow-repeat text-warning';
                    badgeClass = 'bg-warning';
                    badgeText = 'Проверка...';
                    progressClass = 'bg-warning';
                    break;
                case 'error':
                    iconClass = 'bi-exclamation-triangle-fill text-danger';
                    badgeClass = 'bg-danger';
                    badgeText = 'Ошибка';
                    progressClass = 'bg-danger';
                    break;
                default:
                    iconClass = 'bi-question-circle text-secondary';
                    badgeClass = 'bg-secondary';
                    badgeText = 'Неизвестно';
                    progressClass = 'bg-secondary';
            }
            iconEl.className = `bi ${iconClass} status-icon`;
            badgeEl.className = `badge ${badgeClass}`;
            badgeEl.textContent = badgeText;
            progressEl.className = `progress-bar ${progressClass}`;
            progressEl.style.width = status === 'checking' ? '100%' : '100%';
        }

        // Обновление времени последней проверки
        function updateLastCheckTime() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ru-RU', {
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
            lastCheckTimeEl.textContent = timeStr;
        }

        // ==================== НАЗНАЧЕНИЕ ОБРАБОТЧИКОВ СОБЫТИЙ ====================
        btnRefreshIp.addEventListener('click', loadIpAndLocation);
        btnCheckAll.addEventListener('click', checkAllServices);
        // Автоматическая проверка каждые 5 минут
        setInterval(checkAllServices, 5 * 60 * 1000);
    </script>
</body>
</html>
