<!DOCTYPE html>
<html lang="ru" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Status Monitor</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #121212;
            color: #e0e0e0;
            padding-top: 20px;
        }
        .status-card {
            background-color: #1e1e1e;
            border: 1px solid #333;
            margin-bottom: 20px;
        }
        .status-indicator {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }
        .status-up { background-color: #198754; box-shadow: 0 0 10px #198754; }
        .status-down { background-color: #dc3545; box-shadow: 0 0 10px #dc3545; }
        .status-loading { background-color: #ffc107; animation: blink 1s infinite; }
        
        @keyframes blink { 50% { opacity: 0.5; } }
        
        /* Скрываем ссылки визуально, но оставляем функционал */
        .hidden-url { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h2 class="text-center mb-4">Мониторинг Систем</h2>

    <!-- Блок IP и Локации -->
    <div class="card status-card">
        <div class="card-header">Информация о клиенте</div>
        <div class="card-body">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="card-title">Ваш IP</h5>
                    <p class="card-text fs-4" id="user-ip">
                        <span class="spinner-border spinner-border-sm" role="status"></span> Загрузка...
                    </p>
                </div>
                <div class="col-md-6">
                    <h5 class="card-title">Локация</h5>
                    <p class="card-text fs-4" id="user-location">
                        <span class="spinner-border spinner-border-sm" role="status"></span> Загрузка...
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Блок Статусов -->
    <div class="card status-card">
        <div class="card-header">Доступность Сервисов</div>
        <ul class="list-group list-group-flush" id="service-list">
            <!-- Элементы будут обновлены JS -->
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-internet"></span>Интернет (Keenetic)</span>
                <span class="badge bg-secondary" id="badge-internet">Проверка...</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-proxy"></span>Прокси (М9)</span>
                <span class="badge bg-secondary" id="badge-proxy">Проверка...</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-win"></span>Windows-сервер</span>
                <span class="badge bg-secondary" id="badge-win">Проверка...</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-ubuntu"></span>Ubuntu-сервер</span>
                <span class="badge bg-secondary" id="badge-ubuntu">Проверка...</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-gitlab"></span>GitLab</span>
                <span class="badge bg-secondary" id="badge-gitlab">Проверка...</span>
            </li>
            <li class="list-group-item d-flex justify-content-between align-items-center bg-dark text-white border-secondary">
                <span><span class="status-indicator status-loading" id="ind-site"></span>Сайт</span>
                <span class="badge bg-secondary" id="badge-site">Проверка...</span>
            </li>
        </ul>
    </div>
    
    <div class="alert alert-warning mt-3" role="alert">
        <small>Примечание: Для корректной проверки HTTP-ресурсов (Keenetic, Proxy, RDP) разрешите "Небезопасный контент" (Insecure Content) в настройках сайта в браузере.</small>
    </div>

    <div class="text-center mt-3">
        <button class="btn btn-primary" onclick="checkAllServices()">Обновить статусы</button>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
    // Конфигурация URL (не отображаются на странице)
    const URLS = {
        internet: 'http://xata436.crazedns.ru',
        proxy: 'http://xata436.ru:7721/',
        winServer: 'http://xata436.ru:63389/',
        ubuntuServer: 'http://xata436.ru:53389/',
        gitlab: 'https://git.xata436.ru',
        site: 'https://xata436.ru'
    };

    // Получение IP и Локации
    async function getUserInfo() {
        try {
            const response = await fetch('https://ipapi.co/json/');
            const data = await response.json();
            document.getElementById('user-ip').innerText = data.ip || 'Не определен';
            document.getElementById('user-location').innerText = `${data.city}, ${data.country_name}` || 'Не определена';
        } catch (error) {
            document.getElementById('user-ip').innerText = 'Ошибка';
            document.getElementById('user-location').innerText = 'Ошибка API';
        }
    }

    /**
     * Проверка доступности ресурса.
     * Используем mode: 'no-cors', так как мы не можем читать тело ответа (CORS policy),
     * но можем узнать, произошла ли сетевая ошибка (сервер лежит) или запрос прошел (сервер жив).
     */
    async function checkUrl(url, timeout = 5000) {
        const controller = new AbortController();
        const id = setTimeout(() => controller.abort(), timeout);
        
        try {
            // Пытаемся сделать запрос. 
            // no-cors вернет "opaque" ответ, если сервер жив, и throw, если мертв.
            await fetch(url, { 
                mode: 'no-cors', 
                signal: controller.signal,
                cache: 'no-store'
            });
            clearTimeout(id);
            return true; // Сервер ответил (хоть чем-то)
        } catch (error) {
            clearTimeout(id);
            console.warn(`Check failed for ${url}:`, error);
            return false; // Сервер недоступен или заблокирован браузером (Mixed Content)
        }
    }

    // Обновление UI
    function setStatus(key, isUp) {
        const indicator = document.getElementById(`ind-${key}`);
        const badge = document.getElementById(`badge-${key}`);
        
        indicator.className = 'status-indicator ' + (isUp ? 'status-up' : 'status-down');
        badge.className = 'badge ' + (isUp ? 'bg-success' : 'bg-danger');
        badge.innerText = isUp ? 'Доступно' : 'Недоступно';
    }

    function setLoading(key) {
        const indicator = document.getElementById(`ind-${key}`);
        const badge = document.getElementById(`badge-${key}`);
        indicator.className = 'status-indicator status-loading';
        badge.className = 'badge bg-secondary';
        badge.innerText = 'Проверка...';
    }

    async function checkAllServices() {
        const keys = ['internet', 'proxy', 'win', 'ubuntu', 'gitlab', 'site'];
        keys.forEach(k => setLoading(k));

        // Запускаем проверки параллельно
        const results = await Promise.all([
            checkUrl(URLS.internet),      // 0: Internet
            checkUrl(URLS.proxy),         // 1: Proxy
            checkUrl(URLS.winServer),     // 2: Windows
            checkUrl(URLS.ubuntuServer),  // 3: Ubuntu (raw check)
            checkUrl(URLS.gitlab),        // 4: GitLab
            checkUrl(URLS.site)           // 5: Site
        ]);

        let statusInternet = results[0];
        let statusProxy = results[1];
        let statusWin = results[2];
        let rawStatusUbuntu = results[3];
        let statusGitlab = results[4];
        let statusSite = results[5];

        // --- ЛОГИКА ИЗ ТЗ ---
        
        // 1. Интернет и Прокси
        // Из-за CORS мы не можем проверить точное содержимое body.
        // Мы полагаемся на то, что если fetch прошел (true), значит сервер ответил (200, 403, 503 и т.д.).
        // Если fetch упал (false), значит таймаут или обрыв.
        
        // 2. Логика зависимости: "если GitLab И Сайт НЕ работают ТО Ubuntu-сервер НЕ работает"
        let finalStatusUbuntu = rawStatusUbuntu;
        if (!statusGitlab && !statusSite) {
            finalStatusUbuntu = false;
        }

        // Обновляем UI
        setStatus('internet', statusInternet);
        setStatus('proxy', statusProxy);
        setStatus('win', statusWin);
        setStatus('gitlab', statusGitlab);
        setStatus('site', statusSite);
        
        // Ubuntu обновляем последним с учетом логики
        setStatus('ubuntu', finalStatusUbuntu);
    }

    // Запуск при загрузке
    document.addEventListener('DOMContentLoaded', () => {
        getUserInfo();
        checkAllServices();
    });

</script>
</body>
</html>
